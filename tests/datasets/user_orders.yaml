tables:
  test.users:
    primary_key: [id]
    columns: [id, name|str, sample]
  test.orders:
    primary_key: [id]
    columns: [id, user_id, name|str]
    foreign_keys:
      - columns: [user_id]
        dst_table: test.users
        dst_columns: [id]
  test.order_status:
    primary_key: [id]
    columns: [id, order_id, info|str]
    foreign_keys:
      - columns: [order_id]
        dst_table: test.orders
        dst_columns: [id]
data:
  test.users:
    - [1, john, 1]
    - [2, peter, 0]
    - [3, richard, 1]
  test.orders:
    - [1, 1, stuff]
    - [2, 2, junk]
    - [3, 3, gold]
  test.order_status:
    - [1, 1, pending]
    - [2, 1, sent]
    - [3, 2, delivered]
    - [4, 3, lost]

expected_plan:
  queries:
    test.order_status:
      materialize: false
      statement:
        from:
          schema: test
          table: order_status
        type: select
        where:
          columns:
          - order_id
          type: in
          values:
            columns:
            - id
            from:
              sampled: true
              schema: test
              table: orders
            type: select
    test.orders:
      materialize: true
      statement:
        from:
          schema: test
          table: orders
        type: select
        where:
          columns:
          - user_id
          type: in
          values:
            columns:
            - id
            from:
              sampled: true
              schema: test
              table: users
            type: select
    test.users:
      materialize: true
      statement:
        type: select
        from:
          schema: test
          table: users
        where:
          type: in
          columns: [sample]
          values: [[1]]

expected_sample:
  test_out.users:
    - id: 1
      name: john
      sample: 1
    - id: 3
      name: richard
      sample: 1
  test_out.orders:
    - id: 1
      user_id: 1
      name: stuff
    - id: 3
      user_id: 3
      name: gold
  test_out.order_status:
    - id: 1
      order_id: 1
      info: pending
    - id: 2
      order_id: 1
      info: sent
    - id: 4
      order_id: 3
      info: lost
